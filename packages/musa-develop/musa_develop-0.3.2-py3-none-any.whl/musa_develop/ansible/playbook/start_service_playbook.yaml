---
- name: Initialize Docker Swarm Cluster
  hosts: leader
  gather_facts: no
  become: yes
  vars:
    host_ip: "0.0.0.0"  # 默认值

  tasks:
    - name: Copy stack.yaml to /tmp/
      command: sudo musa-develop-ansible --generate-stack-yaml
      register: swarm_status
      changed_when: false
      ignore_errors: yes

    - name: Copy shell script to /tmp/
      command: sudo musa-develop-ansible --generate-shell-script
      register: swarm_status
      changed_when: false
      ignore_errors: yes

    - name: Check Swarm status
      shell: docker stack rm my_hello && HOST_IP={{ host_ip }} docker stack deploy -c /tmp/stack_template.yaml my_hello
      changed_when: false
      ignore_errors: yes
