[tox]
isolated_build = true
envlist =
    py{311,310,39,38,37}
    docs
    style

skip_missing_interpreters = true


[testenv]
deps =
    pytest == 6.2.4
    pytest-mock == 3.6.1
    pytest-cov == 2.12.1

commands =
    # -v: verbose
    # -rsxX: show extra test summary info for (s)skipped, (x)failed, (X)passed
    # -l: show locals in tracebacks
    # --tb=short: short traceback print mode
    # --strict: marks not registered in configuration file raise errors
    # -m "not integration": exclude integration tests
    pytest --cov=pycpg --cov-report xml --cov-report term -v -rsxX -l --tb=short --strict-markers -m "not integration"

[testenv:docs]
deps =
    sphinx == 8.2.3
    myst-parser == 4.0.1
    sphinx_rtd_theme == 3.0.2
    docutils == 0.21.2

allowlist_externals = bash

commands =
    sphinx-build -W -b html -d "{envtmpdir}/doctrees" docs "{envtmpdir}/html"
    bash -c "open {envtmpdir}/html/index.html || true"

[testenv:style]
deps = pre-commit
skip_install = true
commands = pre-commit run --all-files --show-diff-on-failure

[testenv:integration]
passenv = *
commands =
    pytest -v -rsxX -l --tb=short --strict-markers -m integration


[flake8]
select =
    B # bugbear
    E # pycodestyle errors
    F, # flake8 pyflakes
    W # pycodestyle warnings
    B9 # bugbear opinions
    ISC #implicit str concat
extend-ignore =
    B950 # line length, handled by black
    E501 # line length, handled by black
    E722 # bare except, handled by bugbear
    W503 # binary operation line break, different opinion from black
    B904 # exception chaining
    B907 # allow manual quoting

# up to 88 allowed by bugbear B950
max-line-length = 88
per-file-ignores =
    src/pycpg/constants/__init__.py: F401
    docs/conf.py: F401

[pytest]
markers =
    integration: mark test as a integration test
testpaths =
    tests
filterwarnings = error
device_id = 2682772
user_uid = 1215521718938332764

# archive
device_guid = 1215525717144147619
destination_device_guid = 1116204322597572369
archive_guid = 1215522845352377529
path = C:/
