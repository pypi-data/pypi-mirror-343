import{n as ye,a as v,t as F,r as we,c as Q}from"../chunks/Bd4FQpE7.js";import{p as ee,r as Fe,a as M,i as X,s as te,c as y,b as Ie}from"../chunks/ZhKyHBKW.js";import{P as Ae,c as je}from"../chunks/BBLiiV7J.js";import{e as Le,i as ze,c as L,d as ae,f as ke,a as Ee,g as He,I as Me,b as We}from"../chunks/BAITReer.js";import"../chunks/4LrpTdiC.js";import{p as B,k as t,r as z,t as N,a as V,y as ie,v as x,q as w,z as Ge,e as Pe,f as Z,c as E,m as H,s as $}from"../chunks/Bj8SChEI.js";import{u as Re}from"../chunks/BVhLpJTQ.js";import{r as Oe}from"../chunks/Cbydd1_z.js";import{G as Te}from"../chunks/C9s5uA-q.js";import{S as qe}from"../chunks/BLz4nQPc.js";import{a as Be}from"../chunks/Cz2nfeI4.js";var Ne=ye('<svg style="position: absolute; top: 0; left: 0;"></svg>');function Ve(g,e){B(e,!0);const i=ee(e,"sampleImageObjectFit",3,"contain");var a=Ne();Le(a,21,()=>e.sample.annotations,ze,(o,l)=>{qe(o,{get annotation(){return t(l)},get showLabel(){return e.showLabel},get imageWidth(){return e.sample.width}})}),z(a),N(()=>{L(a,"viewBox",`0 0 ${e.sample.width} ${e.sample.height}`),L(a,"preserveAspectRatio",i()==="contain"?"xMidYMid meet":"xMidYMid slice"),L(a,"width",e.containerWidth),L(a,"height",e.containerHeight)}),v(g,a),V()}var Ce=F("<img>");function De(g,e){B(e,!0);const i=ee(e,"objectFit",3,"contain"),a=Fe(e,["$$slots","$$events","$$legacy","sample","objectFit"]),{class:o,...l}=a,{getDatasetVersion:f}=ae();let d=w("");ie(async()=>{var s;(s=e.sample)!=null&&s.dataset_id&&x(d,M(await f(e.sample.dataset_id)))});var c=Ce();let h;N(s=>h=Ee(c,h,{src:`${Ae}${e.sample.file_path_abs}${t(d)?`?v=${t(d)}`:""}`,alt:e.sample.file_path_abs,class:s,decoding:"async",style:`--object-fit: ${i()??""}`,loading:"lazy",...l},"svelte-1c6bz0a"),[()=>ke("sample-image rounded-lg bg-black",o)]),we(c),v(g,c),V()}const Ue=async({dataset_id:g,offset:e=0,limit:i=10,annotationLabels:a,tagIds:o,min_width:l,max_width:f,min_height:d,max_height:c,textEmbedding:h=[]})=>{const s={data:[],error:void 0};try{const I=l!==void 0?{min_width:l,max_width:f,min_height:d,max_height:c}:{},u=await je.GET("/api/samples",{params:{query:{dataset_id:g,offset:e,limit:i,annotation_labels:a,tag_ids:o,text_embedding:h,...I}}});if(u.error)throw new Error(JSON.stringify(u.error,null,2));if(!u.data)throw new Error("No data");s.data=u.data}catch(I){s.error="Error loading samples: "+String(I)}return s};var Ye=F('<div class="relative"><div class="absolute right-7 top-1 z-10"><!></div> <a class="block"><!> <!></a></div>'),Je=F('<div slot="noMore"></div>'),Ke=F('<div slot="noResults"></div>'),Qe=F('<div class="viewport flex-1 svelte-gzepom"><!></div>'),Xe=F('<div class="flex h-full w-full items-center justify-center"><div>Loading...</div></div>');function Ze(g,e){B(e,!0);const[i,a]=te(),o=()=>y(I,"$infiniteLoaderIdentifier",i),l=()=>y(e.dimensions,"$dimensions",i),f=()=>y(e.selectedAnnotationFilter,"$selectedAnnotationFilter",i),d=()=>y(s,"$tagsSelected",i),c=()=>y(e.textEmbedding,"$textEmbedding",i),h=()=>y(se,"$selectedSampleIds",i),{tagsSelected:s}=Re({dataset_id:e.dataset_id,kind:["sample"]});let I=Ge([e.selectedAnnotationFilter,s,e.dimensions,e.textEmbedding],([n,r,p,b])=>n.join(",")+Array.from(r).join(",")+p.min_width+p.max_width+p.min_height+p.max_height+(b?b.queryText:"")),u=w(0);const W=100;let _=w(M([])),G=w(null),C=w(!0),D=w(!1);const{selectedSampleIds:se,toggleSampleSelection:ne,getDatasetVersion:oe,settings:re}=ae();let P=w("cover");ie(async()=>{await oe(e.dataset_id);const n=await re.get();x(P,M(n.grid_view_sample_rendering)),x(D,!0)}),Pe(()=>{o(),x(_,M([])),x(u,0)});async function le({detail:{loaded:n,complete:r}}){const p=t(C)?void 0:l(),b=await Ue({dataset_id:e.dataset_id,limit:W,offset:t(u),annotationLabels:f().length>0?f():void 0,tagIds:d().size>0?Array.from(d()):void 0,textEmbedding:c()?c().embedding:void 0,...p});b.data.length?(x(u,t(u)+W),t(_).push(...b.data),x(C,!1),b.data.length<W?r():n()):r()}const U=16,de=He(),[ce,$e]=de;var Y=Q(),me=Z(Y);{var ge=n=>{var r=Qe(),p=E(r);const b=H(()=>e.sampleHeight+U),_e=H(()=>e.sampleWidth+U),ve=H(()=>{var A;return((A=t(G))==null?void 0:A.clientHeight)||0});Te(p,{get itemCount(){return t(_).length},get itemHeight(){return t(b)},get itemWidth(){return t(_e)},get height(){return t(ve)},class:"overflow-none overflow-y-auto dark:[color-scheme:dark]",get style(){return`--sample-width: ${e.sampleWidth??""}px; --sample-height: ${e.sampleHeight??""}px;`},overScan:100,item:(R,m)=>{let S=()=>m==null?void 0:m().index,j=()=>m==null?void 0:m().style;var J=Q(),fe=Z(J);{var he=O=>{var k=Ye(),T=E(k),pe=E(T);const be=H(()=>h().has(t(_)[S()].sample_id));Be(pe,{onSelect:()=>ne(t(_)[S()].sample_id),get isSelected(){return t(be)}}),z(T);var q=$(T,2),K=E(q);De(K,{get sample(){return t(_)[S()]},get objectFit(){return t(P)}});var Se=$(K,2);Ve(Se,{get sample(){return t(_)[S()]},get containerWidth(){return e.sampleWidth},get sampleImageObjectFit(){return t(P)},get containerHeight(){return e.sampleHeight}}),z(q),z(k),N(xe=>{We(k,j()),L(q,"href",xe)},[()=>ce(Oe.toSample(t(_)[S()].sample_id),void 0)]),v(O,k)};X(fe,O=>{t(_)[S()]&&O(he)})}v(R,J)},footer:R=>{Me(R,{get identifier(){return o()},$$events:{infinite:le},$$slots:{noMore:(m,S)=>{var j=Je();v(m,j)},noResults:(m,S)=>{var j=Ke();v(m,j)}}})},$$slots:{item:!0,footer:!0}}),z(r),Ie(r,A=>x(G,A),()=>t(G)),v(n,r)},ue=n=>{var r=Xe();v(n,r)};X(me,n=>{t(D)?n(ge):n(ue,!1)})}v(g,Y),V(),a()}function gt(g,e){const[i,a]=te(),o=()=>y(s,"$boundedSampleSize",i),{datasetId:l,sampleSize:f,dimensions:d,selectedAnnotationFilter:c,globalStorage:{textEmbedding:h}}=e.data,s=f.sampleSize;Ze(g,{get sampleHeight(){return o().height},get sampleWidth(){return o().width},textEmbedding:h,dataset_id:l,selectedAnnotationFilter:c,dimensions:d}),a()}export{gt as component};
