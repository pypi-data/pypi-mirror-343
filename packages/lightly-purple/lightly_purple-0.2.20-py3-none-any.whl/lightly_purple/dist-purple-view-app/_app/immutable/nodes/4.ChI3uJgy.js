import{c as nt,a as h,t as F,n as xt}from"../chunks/Bd4FQpE7.js";import{a as W,i as N,s as st,c as L,b as St,p as kt}from"../chunks/ZhKyHBKW.js";import{p as lt,y as ct,z as yt,q as I,e as pt,f as it,a as _t,v as x,k as e,c as C,m as b,r as z,s as gt,t as q}from"../chunks/Bj8SChEI.js";import{d as ot,g as At,I as It,b as P,c as ht,u as Lt}from"../chunks/BAITReer.js";import{u as Ct}from"../chunks/BVhLpJTQ.js";import{r as zt}from"../chunks/Cbydd1_z.js";import{c as Ft,P as jt}from"../chunks/BBLiiV7J.js";import{G as Gt}from"../chunks/C9s5uA-q.js";import{g as V,u as Ht}from"../chunks/YrmfYsvT.js";import"../chunks/4LrpTdiC.js";import{a as Mt,S as Et}from"../chunks/Cz2nfeI4.js";const Rt=async({dataset_id:S,offset:t=0,limit:c=10,annotation_label_ids:k,tag_ids:_})=>{const g={data:[],error:void 0};try{const o=await Ft.GET("/api/datasets/{dataset_id}/annotations",{params:{path:{dataset_id:S},query:{annotation_label_ids:k,tag_ids:_,offset:t,limit:c}}});if(o.error)throw new Error(JSON.stringify(o.error,null,2));if(!o.data)throw new Error("No data");g.data=o.data}catch(o){g.error="Error loading annotations: "+String(o)}return g};var Vt=F('<div><div class="absolute right-7 top-1 z-10"><!></div> <a class="block"><!></a></div>'),Pt=F('<div slot="noMore"></div>'),Wt=F('<div slot="noResults"></div>'),Dt=F('<div class="viewport flex-1 svelte-1ppli2f"><!></div>'),Ot=F('<div class="flex h-full w-full items-center justify-center"><div>Loading grid...</div></div>');function Bt(S,t){lt(t,!0);const[c,k]=st(),_=()=>L(O,"$infiniteLoaderIdentifier",c),g=()=>L(t.selectedAnnotationFilterIds,"$selectedAnnotationFilterIds",c),o=()=>L(v,"$tagsSelected",c),u=()=>L(M,"$pickedAnnotationIds",c),{tagsSelected:v}=Ct({dataset_id:t.dataset_id,kind:["annotation"]}),{getDatasetVersion:J}=ot();let D=I(""),j=I(!1);ct(async()=>{x(D,W(await J(t.dataset_id))),x(j,!0)});let O=yt([t.selectedAnnotationFilterIds,v],([l,r])=>l.join(",")+Array.from(r).join(",")),w=I(0);const H=100;let d=I(W([])),s=I(null);pt(()=>{_(),x(d,W([])),x(w,0)});async function X({detail:{loaded:l,complete:r}}){const p=await Rt({dataset_id:t.dataset_id,limit:H,offset:e(w),annotation_label_ids:g().length>0?g():void 0,tag_ids:o().size>0?Array.from(o()):void 0});p.data.length?(x(w,e(w)+H),e(d).push(...p.data),p.data.length<H?r():l()):r()}const{selectedSampleAnnotationCropIds:M,toggleSampleAnnotationCropSelection:Y}=ot(),G=16,K=At(),[Q,y]=K;var B=nt(),Z=it(B);{var $=l=>{var r=Dt(),p=C(r);const a=b(()=>t.itemHeight+G),m=b(()=>t.itemWidth+G),E=b(()=>{var f;return((f=e(s))==null?void 0:f.clientHeight)||0});Gt(p,{get itemCount(){return e(d).length},get itemHeight(){return e(a)},get itemWidth(){return e(m)},get height(){return e(E)},class:"overflow-none overflow-y-auto dark:[color-scheme:dark]",get style(){return`--sample-width: ${t.itemWidth??""}px; --sample-height: ${t.itemHeight??""}px;`},item:(R,n)=>{let i=()=>n==null?void 0:n().index,A=()=>n==null?void 0:n().style;var dt=nt(),ut=it(dt);{var vt=tt=>{var U=Vt(),et=C(U),mt=C(et);const ft=b(()=>u().has(e(d)[i()].annotation_id));Mt(mt,{onSelect:()=>Y(e(d)[i()].annotation_id),get isSelected(){return e(ft)}}),z(et);var at=gt(et,2),bt=C(at);Nt(bt,{get annotation(){return e(d)[i()]},get width(){return t.itemWidth},get height(){return t.itemHeight},get cachedDatasetVersion(){return e(D)}}),z(at),z(U),q(wt=>{P(U,A()),ht(at,"href",wt)},[()=>Q(zt.toSampleWithAnnotation(e(d)[i()].sample.sample_id,e(d)[i()].annotation_id),void 0)]),h(tt,U)};N(ut,tt=>{e(d)[i()]&&e(d)[i()].sample&&tt(vt)})}h(R,dt)},footer:R=>{It(R,{get identifier(){return _()},$$events:{infinite:X},$$slots:{noMore:(n,i)=>{var A=Pt();h(n,A)},noResults:(n,i)=>{var A=Wt();h(n,A)}}})},$$slots:{item:!0,footer:!0}}),z(r),St(r,f=>x(s,f),()=>e(s)),h(l,r)},T=l=>{var r=Ot();h(l,r)};N(Z,l=>{e(j)?l($):l(T,!1)})}h(S,B),_t(),k()}var Tt=xt("<svg><!></svg>"),Ut=F('<div class="crop rounded-lg bg-black svelte-1pj3t6a"><div class="annotation-box svelte-1pj3t6a"><div class="annotation-label text-sm text-white svelte-1pj3t6a"></div> <!></div></div>'),qt=F('<div class="crop flex items-center justify-center rounded-lg bg-black svelte-1pj3t6a"><div class="text-xs text-gray-400">Loading...</div></div>');function Nt(S,t){lt(t,!0);const[c,k]=st(),_=()=>L(D,"$customLabelColorsStore",c),g=()=>L(K,"$taskMap",c);let o=kt(t,"cachedDatasetVersion",3,"");const u=20,v=t.annotation.sample,{getDatasetVersion:J}=ot(),{customLabelColorsStore:D}=Ht();let j=I(W(o())),O=I(!!o());ct(async()=>{!o()&&t.annotation.annotation_id&&(x(j,W(await J(t.annotation.annotation_id.split("-")[0]))),x(O,!0))});function w(){return Math.min(t.width/(t.annotation.width+u*2),t.height/(t.annotation.height+u*2))}function H(){const a=w();return-(t.annotation.x-u)*a+(t.width-(t.annotation.width+u*2)*a)/2}function d(){const a=w();return-(t.annotation.y-u)*a+(t.height-(t.annotation.height+u*2)*a)/2}let s=t.annotation.annotation_label.annotation_label_name;const X=b(()=>{var a;return((a=_()[s])==null?void 0:a.color)??V(s,1).color}),M=b(()=>{var a;return(a=_()[s])==null||a.color,V(s,.4).color}),Y=b(()=>{var a;return((a=_()[s])==null?void 0:a.alpha)??.4}),G=!!t.annotation.segmentation__binary_mask__rle_row_wise,{taskMap:K}=Lt(),Q=b(()=>t.annotation.annotation_task_id&&g().has(t.annotation.annotation_task_id)?g().get(t.annotation.annotation_task_id).is_prediction:!1),y=w(),B=H(),Z=d(),$=b(()=>`${jt+encodeURIComponent(v.file_path_abs)}${e(j)?`?v=${e(j)}`:""}`);var T=nt(),l=it(T);{var r=a=>{var m=Ut(),E=C(m),f=C(E);f.textContent=s;var rt=gt(f,2);{var R=n=>{var i=Tt(),A=C(i);Et(A,{get segmentation(){return t.annotation.segmentation__binary_mask__rle_row_wise},get width(){return v.width},get colorFill(){return e(M)},get opacity(){return e(Y)}}),z(i),q(()=>ht(i,"viewBox",`${t.annotation.x} ${t.annotation.y} ${t.annotation.width} ${t.annotation.height}`)),h(n,i)};N(rt,n=>{G&&n(R)})}z(E),z(m),q((n,i)=>{P(m,`
        width: ${t.width}px;
        height: ${t.height}px;
        background-image: url("${e($)}");
        background-position: ${B}px ${Z}px;
        background-size: ${v.width*y}px ${v.height*y}px;
        background-repeat: no-repeat;
    `),P(E,n),P(f,i)},[()=>`
            left: ${(t.width-t.annotation.width*y)/2}px;
            top: ${(t.height-t.annotation.height*y)/2}px;
            width: ${t.annotation.width*y}px;
            height: ${t.annotation.height*y}px;
            border-color: ${G?"transparent":e(X)??V(s).color};
            background-color: ${G?"transparent":e(M)??V(s,.4).color};
            border-style: ${e(Q)?"dashed":"solid"};
            
        `,()=>`background-color: ${e(M)??V(s,.4).color};`]),h(a,m)},p=a=>{var m=qt();q(()=>P(m,`width: ${t.width}px; height: ${t.height}px;`)),h(a,m)};N(l,a=>{e(O)?a(r):a(p,!1)})}h(S,T),_t(),k()}function ie(S,t){const[c,k]=st(),_=()=>L(v,"$boundedSampleSize",c),{datasetId:g,sampleSize:o,selectedAnnotationFilterIds:u}=t.data,v=o.sampleSize;Bt(S,{get itemHeight(){return _().height},get itemWidth(){return _().width},dataset_id:g,selectedAnnotationFilterIds:u}),k()}export{ie as component};
