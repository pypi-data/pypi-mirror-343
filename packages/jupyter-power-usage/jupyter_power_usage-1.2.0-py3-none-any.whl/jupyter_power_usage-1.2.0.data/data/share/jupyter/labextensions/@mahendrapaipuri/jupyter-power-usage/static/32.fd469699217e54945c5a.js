"use strict";(self.webpackChunk_mahendrapaipuri_jupyter_power_usage=self.webpackChunk_mahendrapaipuri_jupyter_power_usage||[]).push([[32],{32:(e,t,n)=>{n.r(t),n.d(t,{default:()=>H});var r=n(691),s=n(793),i=n(29),a=n.n(i),o=n(496);function c(e,t){return e>.5?e>.8?"red":"orange":t}const l=({percentage:e,color:t})=>a().createElement("div",{className:"jp-IndicatorFiller",style:{width:100*e+"%",background:`${t}`}}),u=({values:e,percentage:t,baseColor:n})=>{const[r,s]=(0,i.useState)(!1),u=c(t,n);return a().createElement("div",{className:"jp-IndicatorBar",onClick:()=>{s(!r)}},r&&a().createElement(o.Sparklines,{data:e,min:0,max:1,limit:e.length,margin:0},a().createElement(o.SparklinesLine,{style:{stroke:u,strokeWidth:4,fill:u,fillOpacity:1}}),a().createElement(o.SparklinesSpots,null)),!r&&a().createElement(l,{percentage:t,color:u}))},p=({enabled:e,indicatorBarEnabled:t,values:n,label:r,color:s,text:i})=>{const o=n[n.length-1],l=c(o,s);return e&&a().createElement("div",{className:"jp-IndicatorContainer"},a().createElement("div",{className:"jp-IndicatorText"},r),null!==o&&t&&a().createElement("div",{className:"jp-IndicatorWrapper"},a().createElement(u,{values:n,percentage:o,baseColor:s})),a().createElement("div",{className:"jp-IndicatorText",style:{color:!t&&l}},i))},d=({model:e,indicatorBarEnabled:t,label:n})=>{const[r,s]=(0,i.useState)(""),[o,c]=(0,i.useState)([]),l=()=>{const{currentCpuPower:t,currentCpuPowerLimit:n}=e,r=`${t.toFixed(2)} ${n?"/ "+n.toFixed(0):""} W`,i=e.values.map((e=>e.cpuPowerShare));s(r),c(i)};return(0,i.useEffect)((()=>(e.changed.connect(l),()=>{e.changed.disconnect(l)})),[e]),a().createElement(p,{enabled:e.cpuPowerAvailable,indicatorBarEnabled:t,values:o,label:n,color:"#1AB7AE",text:r})};var h;!function(e){e.createPowerView=(e,t,n)=>r.ReactWidget.create(a().createElement(d,{model:e,indicatorBarEnabled:t,label:n}))}(h||(h={}));const m=({model:e,indicatorBarEnabled:t,label:n})=>{const[r,s]=(0,i.useState)(""),[o,c]=(0,i.useState)([]),l=()=>{const{currentGpuPower:t,currentGpuLimit:n}=e,r=`${t.toFixed(2)} ${n?"/ "+n.toFixed(0):""} W`,i=e.values.map((e=>e.gpuPowerShare));s(r),c(i)};return(0,i.useEffect)((()=>(e.changed.connect(l),()=>{e.changed.disconnect(l)})),[e]),a().createElement(p,{enabled:e.gpuPowerAvailable,indicatorBarEnabled:t,values:o,label:n,color:"#76B900",text:r})};var g;!function(e){e.createPowerView=(e,t,n)=>r.ReactWidget.create(a().createElement(m,{model:e,indicatorBarEnabled:t,label:n}))}(g||(g={}));const f=({enabled:e,text:t})=>e&&a().createElement("div",{className:"jp-IndicatorContainer"},a().createElement("div",{className:"jp-IndicatorText"},a().createElement("span",null,"eCO",a().createElement("sub",null,"2"),":")),a().createElement("div",{className:"jp-IndicatorText"},t)),v=({model:e})=>{const[t,n]=(0,i.useState)(""),r=()=>{const{currentEmissions:t,emissionsUnits:r}=e,s=["mg","g","kg"].indexOf(r)>0?0:2,i=`${t.toFixed(s)} ${e.emissionsUnits}`;n(i)};return(0,i.useEffect)((()=>(e.changed.connect(r),()=>{e.changed.disconnect(r)})),[e]),a().createElement(f,{enabled:e.emissionsAvailable,text:t})};var w;!function(e){e.createEmissionsView=e=>r.ReactWidget.create(a().createElement(v,{model:e}))}(w||(w={}));var _=n(641),b=n(110),E=n(797),y=n(901);const P=1e3,x=1e6;var A,F;!function(e){e.getOpenDataSoftEmissionFactor=async()=>{var e,t;const n={dataset:"eco2mix-national-tr",facet:"date_heure",start:"0",rows:"1",sort:"date_heure",timezone:"Europe/Paris",q:`date_heure:[${(new Date).toISOString().split("T")[0]} TO #now()] AND NOT #null(taux_co2)`},r=_.URLExt.objectToQueryString(n),s=_.URLExt.join("https://odre.opendatasoft.com","/api/records/1.0/search/",r);try{const n=await fetch(s,{method:"GET"});if(!n.ok)return console.debug("Request to Opendatasoft API failed"),null;const r=await n.json();if(r&&r.records&&r.records.length>0)return(null===(t=null===(e=r.records[0])||void 0===e?void 0:e.fields)||void 0===t?void 0:t.taux_co2)||0}catch(e){return console.info(`Request to Opendatasoft API failed due to ${e}`),null}return null}}(A||(A={})),function(e){const t="/v3/carbon-intensity/latest",n=b.ServerConnection.makeSettings();e.getElectricityMapsEmissionFactor=async(e,r,s)=>{const i={zone:s.toUpperCase()},a=_.URLExt.objectToQueryString(i);try{let s;const i=new Headers;r.length>0&&i.set("auth-token",r),s=e?_.URLExt.join(n.baseUrl,"api/metrics/v1/emission_factor/emaps",t,a):_.URLExt.join("https://api.electricitymap.org",t,a);const o=await fetch(s,{method:"GET",headers:i});if(!o.ok)return console.debug("Request to Electricity Maps API failed"),null;const c=await o.json();if(c&&c.carbonIntensity)return c.carbonIntensity||0}catch(e){return console.info(`Request to Electricity Maps failed due to ${e}`),null}return null}}(F||(F={}));const U=async function(e,t,n,r){return"rte"===e?await A.getOpenDataSoftEmissionFactor():"emaps"===e?await F.getElectricityMapsEmissionFactor(t,n.emaps,r):null};var C,S,j;!function(e){class t extends r.VDomModel{constructor(e,t){super(),this._cpuPowerUsageAvailable=!1,this._gpuPowerUsageAvailable=!1,this._emissionsAvailable=!1,this._currentCpuPowerLimit=null,this._currentCpuPowerUsage=null,this._currentGpuPowerUsage=null,this._currentGpuPowerLimit=null,this._currentEmissions=null,this._lastEmissionReading=Date.now(),this._lastEmissionFactor=null,this._totalEmissions=0,this._values=[],this._emissionModel=e;for(let e=0;e<20;e++)this._values.push({cpuPowerShare:0,gpuPowerShare:0});this._poll=new E.Poll({factory:()=>j.powerUsageFactory(),frequency:{interval:t.refreshRate,backoff:!0},name:"jupyter-power-usage:PowerUsage#metrics"}),this._poll.ticked.connect((e=>{const{payload:t,phase:n}=e.state;if("resolved"!==n){if("rejected"===n){const e=this._cpuPowerUsageAvailable;return this._cpuPowerUsageAvailable=!1,this._gpuPowerUsageAvailable=!1,this._emissionsAvailable=!1,this._currentCpuPowerLimit=null,this._currentCpuPowerUsage=null,this._currentGpuPowerUsage=null,this._currentGpuPowerLimit=null,this._currentEmissions=null,void(e&&this.stateChanged.emit())}}else this._updateMetricsValues(t)}))}async refresh(){await this._poll.refresh(),await this._poll.tick}get cpuPowerAvailable(){return this._cpuPowerUsageAvailable}get gpuPowerAvailable(){return this._gpuPowerUsageAvailable}get emissionsAvailable(){return this._emissionsAvailable&&(this._cpuPowerUsageAvailable||this._gpuPowerUsageAvailable)}get currentCpuPower(){return this._currentCpuPowerUsage}get currentCpuPowerLimit(){return this._currentCpuPowerLimit}get currentGpuPower(){return this._currentGpuPowerUsage}get currentGpuLimit(){return this._currentGpuPowerLimit}get currentEmissions(){return this._currentEmissions}get totalEmissions(){return this._totalEmissions}get emissionsUnits(){return this._emissionsUnits}get changed(){return this.stateChanged}get values(){return this._values}dispose(){this._poll.dispose()}_updateMetricsValues(e){if(null===e)return this._cpuPowerUsageAvailable=!1,this._gpuPowerUsageAvailable=!1,this._emissionsAvailable=!1,this._currentCpuPowerLimit=null,this._currentCpuPowerUsage=null,this._currentGpuPowerUsage=null,this._currentGpuPowerLimit=null,void(this._currentEmissions=null);const t=e.cpu?e.cpu.usage:null,n=e.cpu?e.cpu.limit:null;this._cpuPowerUsageAvailable=!!t,this._currentCpuPowerUsage=t,this._currentCpuPowerLimit=n;const r=e.gpu?e.gpu.usage:null,s=e.gpu?e.gpu.limit:null;this._gpuPowerUsageAvailable=!!r,this._currentGpuPowerUsage=r,this._currentGpuPowerLimit=s;const{emissionFactorAvailable:i,currentEmissionFactor:a}=this._emissionModel;if(this._lastEmissionFactor=i?a:this._lastEmissionFactor,this._emissionsAvailable=null!==this._lastEmissionFactor,this._emissionsAvailable){const e=Date.now()-this._lastEmissionReading,n=(t||0)+(r||0),s=this._lastEmissionFactor*n*e/1e3;this._lastEmissionReading=Date.now();const i=this._totalEmissions+s,[a,c]=(o=i)?o<P?[o,"mg"]:P===o||o<x?[o/P,"g"]:[o/x,"kg"]:[0,"mg"];this._currentEmissions=a,this._emissionsUnits=c,this._totalEmissions=i}var o;const c=this._currentCpuPowerLimit?Math.min(this._currentCpuPowerUsage/this._currentCpuPowerLimit,1):null,l=this._currentGpuPowerUsage&&this._currentGpuPowerLimit?Math.min(this._currentGpuPowerUsage/this._currentGpuPowerLimit,1):null;this._values.push({cpuPowerShare:c,gpuPowerShare:l}),this._values.shift(),this.stateChanged.emit(void 0)}}e.Model=t}(C||(C={})),function(e){e.Model=class{constructor(e){this._emissionFactorAvailable=!1,this._useProxy=!1,this._currentEmissionFactor=null,this._changed=new y.Signal(this),"emaps"===e.emissionFactorSource&&new Promise((()=>{U(e.emissionFactorSource,!0,e.accessTokens,e.countryCode).then((e=>{this._useProxy=!!e})).catch((()=>{console.warn("Emission factor from Electricity maps will be fetched by making API requests directly from the browser. If a access token has been set, this can pose security risks. Please configure the access token on Jupyter server extension."),this._useProxy=!1}))})),this._poll=new E.Poll({factory:()=>j.emissionsFactory(e.emissionFactorSource,this._useProxy,e.accessTokens,e.countryCode,e.defaultEmissionFactor),frequency:{interval:e.refreshRate,backoff:!0},name:"jupyter-power-usage:EmissionFactor#metrics"}),this._poll.ticked.connect((e=>{const{payload:t,phase:n}=e.state;if("resolved"!==n){if("rejected"===n){const e=this._emissionFactorAvailable;return this._emissionFactorAvailable=!1,this._currentEmissionFactor=null,void(e&&this._changed.emit())}}else this._updateMetricsValues(t)}))}async refresh(){await this._poll.refresh(),await this._poll.tick}get emissionFactorAvailable(){return this._emissionFactorAvailable}get currentEmissionFactor(){return this._currentEmissionFactor}dispose(){this._poll.dispose()}_updateMetricsValues(e){if(null===e)return this._emissionFactorAvailable=!1,void(this._currentEmissionFactor=null);const t=e;this._emissionFactorAvailable=null!==t,this._currentEmissionFactor=t,this._changed.emit(void 0)}}}(S||(S={})),function(e){const t=b.ServerConnection.makeSettings(),n=_.URLExt.join(t.baseUrl,"api/metrics/v1/power_usage");e.powerUsageFactory=async()=>{const e=b.ServerConnection.makeRequest(n,{},t),r=await e;return r.ok?await r.json():null},e.emissionsFactory=async(e,t,n,r,s)=>{const i=await U(e,t,n,r);return i?i/3600:s/3600}}(j||(j={}));var k=n(379),I=n.n(k),T=n(795),L=n.n(T),R=n(569),M=n.n(R),G=n(565),B=n.n(G),N=n(216),q=n.n(N),O=n(589),V=n.n(O),D=n(760),$={};$.styleTagTransform=V(),$.setAttributes=B(),$.insert=M().bind(null,"head"),$.domAPI=L(),$.insertStyleElement=q(),I()(D.Z,$),D.Z&&D.Z.locals&&D.Z.locals;const W=5e3,Z=18e5,z={id:"@mahendrapaipuri/jupyter-power-usage:plugin",autoStart:!0,requires:[r.IToolbarWidgetRegistry],optional:[s.ISettingRegistry],activate:async(e,t,n)=>{console.log("@mahendrapaipuri/jupyter-power-usage extension is activated");let r=W,s=!1,i="CPU Power: ",a="GPU Power: ",o=Z,c="rte",l="",u="fr",p=475;if(n){const e=await n.load(z.id);r=e.get("refreshRate").composite,r<W&&(console.log("Refresh rate is floored at 5000 ms"),r=W),s=e.get("indicatorBarDisabled").composite;const t=e.get("emissions").composite;c=t.source,l=t.emapsAccessToken,u=t.countryCode,o=t.refreshRate,p=t.factor,o<Z&&(console.log("Emissions update interval is floored at 1800000 ms"),o=Z);const d=e.get("cpu").composite;i=d.label;const h=e.get("gpu").composite;a=h.label}const d=new S.Model({refreshRate:o,emissionFactorSource:c,accessTokens:{emaps:l},countryCode:u,defaultEmissionFactor:p});await d.refresh();const m=new C.Model(d,{refreshRate:r});await m.refresh(),m.cpuPowerAvailable||m.gpuPowerAvailable||(console.log("Power metrics are not available..."),m.dispose(),d.dispose()),m.cpuPowerAvailable&&t.addFactory("TopBar","cpu_power",(()=>h.createPowerView(m,!s,i))),m.gpuPowerAvailable&&t.addFactory("TopBar","gpu_power",(()=>g.createPowerView(m,!s,a))),m.emissionsAvailable&&t.addFactory("TopBar","emissions",(()=>w.createEmissionsView(m)))}},H=z},150:(e,t,n)=>{n.d(t,{Z:()=>o});var r=n(81),s=n.n(r),i=n(645),a=n.n(i)()(s());a.push([e.id,".jp-IndicatorContainer {\n  display: flex;\n  flex-direction: row;\n}\n\n.jp-IndicatorFiller {\n  height: 100%;\n}\n\n.jp-IndicatorText {\n  display: flex;\n  min-width: 35px;\n  flex-direction: column;\n  justify-content: center;\n  text-align: right;\n  white-space: nowrap;\n  overflow: hidden;\n}\n\n.jp-IndicatorWrapper {\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  margin-left: 5px;\n  margin-right: 5px;\n  width: 75px;\n}\n\n.jp-IndicatorBar {\n  height: 75%;\n  outline: 1px solid black;\n}\n\n.jp-IndicatorBar svg {\n  max-width: 100%;\n  height: 100%;\n}\n\n/* To center the subscript in the text */\nsub {\n  top: 0;\n  bottom: 0;\n  line-height: 1;\n  font-size: 0.5em;\n}\n",""]);const o=a},760:(e,t,n)=>{n.d(t,{Z:()=>l});var r=n(81),s=n.n(r),i=n(645),a=n.n(i),o=n(150),c=a()(s());c.i(o.Z),c.push([e.id,"\n",""]);const l=c},645:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",r=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),r&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),r&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,r,s,i){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(r)for(var o=0;o<this.length;o++){var c=this[o][0];null!=c&&(a[c]=!0)}for(var l=0;l<e.length;l++){var u=[].concat(e[l]);r&&a[u[0]]||(void 0!==i&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=i),n&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=n):u[2]=n),s&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=s):u[4]="".concat(s)),t.push(u))}},t}},81:e=>{e.exports=function(e){return e[1]}},379:e=>{var t=[];function n(e){for(var n=-1,r=0;r<t.length;r++)if(t[r].identifier===e){n=r;break}return n}function r(e,r){for(var i={},a=[],o=0;o<e.length;o++){var c=e[o],l=r.base?c[0]+r.base:c[0],u=i[l]||0,p="".concat(l," ").concat(u);i[l]=u+1;var d=n(p),h={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==d)t[d].references++,t[d].updater(h);else{var m=s(h,r);r.byIndex=o,t.splice(o,0,{identifier:p,updater:m,references:1})}a.push(p)}return a}function s(e,t){var n=t.domAPI(t);return n.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,s){var i=r(e=e||[],s=s||{});return function(e){e=e||[];for(var a=0;a<i.length;a++){var o=n(i[a]);t[o].references--}for(var c=r(e,s),l=0;l<i.length;l++){var u=n(i[l]);0===t[u].references&&(t[u].updater(),t.splice(u,1))}i=c}}},569:e=>{var t={};e.exports=function(e,n){var r=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(n)}},216:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},565:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},795:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var r="";n.supports&&(r+="@supports (".concat(n.supports,") {")),n.media&&(r+="@media ".concat(n.media," {"));var s=void 0!==n.layer;s&&(r+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),r+=n.css,s&&(r+="}"),n.media&&(r+="}"),n.supports&&(r+="}");var i=n.sourceMap;i&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},589:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}}]);