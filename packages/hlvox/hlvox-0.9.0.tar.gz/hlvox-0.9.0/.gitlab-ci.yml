# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/#customizing-settings
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
image: python:3.11
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
cache:
  paths:
    - .cache/pip
    - venv/

stages:
  - pre-commit
  - test
  - build
  - deploy

before_script:
  - python -V
  - pip install pipenv
  - pipenv install --dev

pre-commit:
  stage: pre-commit
  script:
    - pipenv run pre-commit run --all

test:
  stage: test
  script:
    - pipenv run pytest --cov=hlvox --cov-report=html tests/
    - pipenv run coverage report -m
  coverage: "/TOTAL.+ ([0-9]{1,3}%)/"
  artifacts:
    paths:
      - htmlcov
    expire_in: 1 day

pages:
  stage: build
  script:
    - pipenv run sphinx-apidoc -o ./doc/source ./hlvox/ -f
    - cd doc
    - pipenv run make html
    - mv build/html/ ../public/
  artifacts:
    paths:
      - public
  only:
    - master

build:
  stage: build
  script:
    - pipenv run python -m build
  artifacts:
    paths:
      - dist/

deploy_staging:
  stage: deploy
  variables:
    TWINE_USERNAME: "$PYPI_USERNAME"
    TWINE_PASSWORD: "$PYPI_TEST_PASSWORD"
  script:
    - pipenv run twine upload --repository-url $TEST_REPOSITORY_URL dist/* $EXTRA_TWINE_ARGS
  except:
    - tags
  only:
    - master

deploy_production:
  stage: deploy
  variables:
    TWINE_USERNAME: "$PYPI_USERNAME"
    TWINE_PASSWORD: "$PYPI_PASSWORD"
  script:
    - pipenv run twine upload --repository-url $DEP_REPOSITORY_URL dist/* $EXTRA_TWINE_ARGS
  only:
    - tags

sast:
  stage: test
  variables:
    SAST_EXCLUDED_PATHS: venv, .venv, cache, .pytest_cache, tests
include:
  - template: Security/SAST.gitlab-ci.yml
